Stage 5 — Data Lab
===================

The Stage 5 milestone introduces the Data Lab experience: an export-first path for capturing
inspector snapshots as seeded notebooks, previewing them inside Electron, and (optionally)
enabling a live bundled kernel when the Electron build is launched with ``--with-data-lab``.

Phase 1 focuses on predictable exports so screenshot authors and QA reviewers can replay the
exact same walkthrough without needing system Python.

Workflow overview
-----------------

1. Open the inspector sidebar and locate the **Data Lab** panel in the assistant rail.
2. Choose a notebook template — ``schema-audit`` captures the ERD metadata while ``log-study`` pulls
   the log excerpt seeded during the scan queue.
3. Click *Export notebook*. DJDesk writes an ``.ipynb`` file to the workspace-scoped data lab folder
   (``INSPECTOR_DATA_LAB_ROOT/<slug>``), records the export in the task history, and surfaces it in
   the panel's list.
4. Select any exported entry to load it in the embedded viewer. The iframe renders the lightweight
   HTML view generated by ``inspector/data_lab.py`` without wiring a kernel.

Embedded viewer + docs parity
-----------------------------

The docs drawer button in the toolbar now opens Read the Docs inside a glassy side panel. Doc links
inside the assistant list are annotated with a ``pane_target`` so the in-app UI can jump to the
matching pane (e.g., Stage 2 opens the Schema tab). Screenshots taken for the docs therefore match
the exact layout contributors see while reading the hosted tutorial.

Live kernel build
-----------------

By default the Data Lab ships as an export-only flow. When the Electron build (or
``just bundle``) runs with ``--with-data-lab``, the same bundled CPython environment installs
``jupyter_server`` + ``ipykernel`` and Django exposes a guarded endpoint for launching one kernel per
workspace. Tokens are ephemeral and the kernel inherits SAFE command policies:

.. code-block:: python

   INSPECTOR_SAFE_COMMANDS = [
       "python manage.py showmigrations",
       "python manage.py check",
       "python manage.py diffsettings",
       "python manage.py sqlmigrate",
       "python manage.py inspectdb",
       "python manage.py dumpdata",
   ]

When the live build variant is not used the UI labels the Data Lab as "Export-only mode" so reviewers
know the embedded iframe is rendering a static HTML snapshot.

Guardrails and automation
-------------------------

* Export commands execute via ``django-tasks`` and respect the SAFE allowlist above — there is no
  shell escaping or write access to the inspected project.
* Notebook exports log to ``WorkspaceTaskRun`` for auditing and reuse the same toast + notification
  UX as other background tasks.
* The Data Lab directory lives under ``var/data_lab/`` (ignored by git) so contributors can safely
  delete or archive exports between runs.
